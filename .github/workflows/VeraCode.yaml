name: Veracode Ultra Workflow (Granular + Auto-Packager + Manual + Basename Fix)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:

  # ðŸ”¹ Veracode SCA
  sca:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.2
      - name: Run Veracode SCA
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SCA }}
        run: |
          curl -sSL 'https://download.sourceclear.com/ci.sh' | bash -s -- scan

  # ðŸ”¹ Detect FULL Stack + Version
  detect_stack:
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
      build_path: ${{ steps.detect.outputs.build_path }}
      node_version: ${{ steps.detect.outputs.node_version }}
      python_version: ${{ steps.detect.outputs.python_version }}
      go_version: ${{ steps.detect.outputs.go_version }}
    steps:
      - uses: actions/checkout@v4.1.2
      - id: detect
        run: |
          lang="unsupported"
          build_path="${{ github.workspace }}"
          node_version=""
          python_version=""
          go_version=""

          echo "ðŸ” Iniciando detecÃ§Ã£o..."

          if find . -name "pom.xml" | grep -q .; then
            lang="maven"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "pom.xml" | head -n1)")"
          elif find . -name "build.gradle" | grep -q .; then
            lang="gradle"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "build.gradle" | head -n1)")"
          elif find . -name "build.gradle.kts" | grep -q .; then
            lang="kotlin"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "build.gradle.kts" | head -n1)")"
          elif find . -name "AndroidManifest.xml" | grep -q .; then
            lang="android"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "AndroidManifest.xml" | head -n1)")"
          elif find . -name "package.json" | grep -q .; then
            if grep -q "react-native" package.json; then
              lang="react_native"
            else
              lang="node"
            fi
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "package.json" | head -n1)")"
            if [ -f .nvmrc ]; then
              node_version=$(cat .nvmrc)
            else
              node_version=$(node -p "require('./package.json').engines?.node || '20'")
            fi
          elif find . -name "pyproject.toml" | grep -q . || find . -name "setup.py" | grep -q .; then
            lang="python"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "pyproject.toml" -o -name "setup.py" | head -n1)")"
            python_version=$(grep -m1 'python =' pyproject.toml | sed 's/.*"\(.*\)"/\1/') || python_version="3.10"
          elif find . -name "go.mod" | grep -q .; then
            lang="go"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "go.mod" | head -n1)")"
            go_version=$(grep '^go ' go.mod | awk '{print $2}') || go_version="1.21"
          elif find . -name "*.sln" | grep -q . || find . -name "*.csproj" | grep -q .; then
            lang="dotnet_framework"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "*.sln" -o -name "*.csproj" | head -n1)")"
          elif find . -name "Makefile" | grep -q . || find . -name "CMakeLists.txt" | grep -q .; then
            lang="cpp"
            build_path="${{ github.workspace }}"
          elif find . -name "build.xml" | grep -q .; then
            lang="ant"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "build.xml" | head -n1)")"
          elif find . -name "composer.json" | grep -q .; then
            lang="php"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "composer.json" | head -n1)")"
          elif find . -name "Gemfile" | grep -q .; then
            lang="ruby"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "Gemfile" | head -n1)")"
          elif find . -name "Podfile" | grep -q . || [ -d "ios" ]; then
            lang="ios"
            build_path="${{ github.workspace }}/ios"
          elif find . -name "pubspec.yaml" | grep -q .; then
            lang="flutter"
            build_path="${{ github.workspace }}/$(dirname "$(find . -name "pubspec.yaml" | head -n1)")"
          fi

          echo "âœ… Language: $lang"
          echo "ðŸ“‚ Path: $build_path"
          [ -n "$node_version" ] && echo "ðŸŸ¢ Node: $node_version"
          [ -n "$python_version" ] && echo "ðŸŸ¢ Python: $python_version"
          [ -n "$go_version" ] && echo "ðŸŸ¢ Go: $go_version"

          if [ "$lang" = "unsupported" ]; then exit 1; fi

          echo "language=$lang" >> $GITHUB_OUTPUT
          echo "build_path=$build_path" >> $GITHUB_OUTPUT
          echo "node_version=$node_version" >> $GITHUB_OUTPUT
          echo "python_version=$python_version" >> $GITHUB_OUTPUT
          echo "go_version=$go_version" >> $GITHUB_OUTPUT

  # ðŸ”¹ Auto-Packager
  build_auto:
    runs-on: ubuntu-latest
    needs: detect_stack
    if: |
      needs.detect_stack.outputs.language == 'maven' ||
      needs.detect_stack.outputs.language == 'gradle' ||
      needs.detect_stack.outputs.language == 'kotlin' ||
      needs.detect_stack.outputs.language == 'android' ||
      needs.detect_stack.outputs.language == 'node' ||
      needs.detect_stack.outputs.language == 'react_native' ||
      needs.detect_stack.outputs.language == 'python' ||
      needs.detect_stack.outputs.language == 'go'
    defaults:
      run:
        working-directory: ${{ needs.detect_stack.outputs.build_path }}
    outputs:
      zipfile: ${{ steps.find_zip.outputs.zipfile }}
    steps:
      - uses: actions/checkout@v4.1.2
      - if: |
          needs.detect_stack.outputs.language == 'node' ||
          needs.detect_stack.outputs.language == 'react_native'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.detect_stack.outputs.node_version }}
      - if: needs.detect_stack.outputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.detect_stack.outputs.python_version }}
      - if: needs.detect_stack.outputs.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ needs.detect_stack.outputs.go_version }}
      - run: |
          mkdir -p "${GITHUB_WORKSPACE}/veracode-out"
          curl -sSfL https://tools.veracode.com/veracode-cli/install | sh
          ./veracode package --source . --output "${GITHUB_WORKSPACE}/veracode-out" --trust
      - id: find_zip
        run: |
          found=$(find "${GITHUB_WORKSPACE}/veracode-out" -name '*.zip' | head -n1)
          echo "zipfile=$(basename $found)" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        with:
          name: veracode-package
          path: "${GITHUB_WORKSPACE}/veracode-out/${{ steps.find_zip.outputs.zipfile }}"

  # ðŸ”¹ Manual Linux
  build_manual:
    runs-on: ubuntu-latest
    needs: detect_stack
    if: |
      needs.detect_stack.outputs.language == 'cpp' ||
      needs.detect_stack.outputs.language == 'ant' ||
      needs.detect_stack.outputs.language == 'php' ||
      needs.detect_stack.outputs.language == 'ruby' ||
      needs.detect_stack.outputs.language == 'flutter'
    steps:
      - uses: actions/checkout@v4.1.2
      - if: needs.detect_stack.outputs.language == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
      - run: |
          mkdir -p "${GITHUB_WORKSPACE}/veracode-out/output"
          lang="${{ needs.detect_stack.outputs.language }}"
          if [ "$lang" = "cpp" ]; then make || cmake . && make && cp -r ./ "${GITHUB_WORKSPACE}/veracode-out/output/"
          elif [ "$lang" = "ant" ]; then ant build && cp -r build/* "${GITHUB_WORKSPACE}/veracode-out/output/"
          elif [ "$lang" = "php" ]; then composer install || true && rsync -av ./ "${GITHUB_WORKSPACE}/veracode-out/output" --exclude vendor --exclude .git
          elif [ "$lang" = "ruby" ]; then bundle install || true && rsync -av ./ "${GITHUB_WORKSPACE}/veracode-out/output" --exclude .git
          elif [ "$lang" = "flutter" ]; then flutter pub get && flutter build apk --debug && cp build/app/outputs/flutter-apk/*.apk "${GITHUB_WORKSPACE}/veracode-out/output/"
          fi
      - run: |
          cd "${GITHUB_WORKSPACE}/veracode-out"
          zip -r veracode-manual.zip output
      - uses: actions/upload-artifact@v4
        with:
          name: veracode-package
          path: "${GITHUB_WORKSPACE}/veracode-out/veracode-manual.zip"

  # ðŸ”¹ Manual macOS
  build_manual_mac:
    runs-on: macos-latest
    needs: detect_stack
    if: needs.detect_stack.outputs.language == 'ios'
    steps:
      - uses: actions/checkout@v4.1.2
      - run: |
          mkdir -p "${GITHUB_WORKSPACE}/veracode-out/output"
          rsync -av ./ "${GITHUB_WORKSPACE}/veracode-out/output" --exclude .git
      - run: |
          cd "${GITHUB_WORKSPACE}/veracode-out"
          zip -r veracode-ios.zip output
      - uses: actions/upload-artifact@v4
        with:
          name: veracode-package
          path: "${GITHUB_WORKSPACE}/veracode-out/veracode-ios.zip"

  # ðŸ”¹ Pipeline Scan
  pipeline_scan:
    runs-on: ubuntu-latest
    needs: [build_auto, build_manual, build_manual_mac]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: veracode-package
          path: "${GITHUB_WORKSPACE}/veracode-out"
      - uses: veracode/Veracode-pipeline-scan-action@v1.0.18
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          file: "${GITHUB_WORKSPACE}/veracode-out/*.zip"
          fail_build: true

  # ðŸ”¹ Upload & Scan
  sast:
    runs-on: ubuntu-latest
    needs: [pipeline_scan]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: veracode-package
          path: "${GITHUB_WORKSPACE}/veracode-out"
      - uses: veracode/veracode-uploadandscan-action@0.2.8
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          appname: "GitHub - ${{ github.repository }}"
          createprofile: true
          filepath: "${GITHUB_WORKSPACE}/veracode-out/*.zip"
          version: ${{ github.run_id }}
